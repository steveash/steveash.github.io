---
layout: post
title: Hibernate4 SessionFactoryBuilder gotcha
date: '2012-04-02T20:08:00.001-05:00'
author: Steve Ash
tags: 
modified_time: '2012-04-02T20:10:40.031-05:00'
blogger_id: tag:blogger.com,1999:blog-4471109663192942674.post-573363445488565316
blogger_orig_url: http://blog.manycupsofcoffee.com/2012/04/hibernate4-sessionfactorybuilder-gotcha.html
---

<p>Just upgraded one of our projects to Spring 3.1.1 and Hibernate 4.1.1 today and ran into a small problem that ate up some time.</p> <h3>Symptom:</h3><p>It appeared as if all of my hibernate &lt;property&gt;'s in hibernate.cfg.xml were suddenly not being picked up -- they were just silently being ignored.</p> <p>So for example, for our unit tests, we run Derby with hibernate.hbm2ddl = create so that the schema is generated dynamically each time.  In Hibernate 3.6 we used two files: hibernate.cfg.xml (packaged in the jar, not for customers) and hibernate.local.cfg.xml (placed in the customer's etc directory on the class path for support/production time overrides, etc.).</p> <p>Well in migrating to Hibernate4 I took advantage of Spring's new hibernate4.LocalSessionFactoryBuilder class to help build my metadata and I got rid of my hibernate.cfg.xml entirely.</p> <p>I used it like so:</p> <pre class="brush: java"><br />    @Bean<br />    public SessionFactory sessionFactory() {<br />        return new LocalSessionFactoryBuilder(dataConfig.dataSource())<br />            .scanPackages(DatabasePackage)<br />            .addPackage(DatabasePackage)<br />            .addProperties(dataConfig.hibernateProperties())<br />            .addResource("hibernate.local.cfg.xml")<br />            .buildSessionFactory();<br />    }<br /></pre> And I had a hibernate.local.cfg.xml in my src/test/resources that looked like:  <pre class="brush: java"><br />&lt;hibernate-configuration&gt;<br />  &lt;session-factory&gt;<br />    &lt;property name="hibernate.hbm2ddl.auto"&gt;create&lt;/property&gt;<br />  &lt;/session-factory&gt;<br />&lt;/hibernate-configuration&gt;<br /></pre> <p>But it wasn't being picked up!  I tried adding mappings in to it and those were picked up.  Finally after digging through the Hibernate source I realized the problem.  Adding hibernate.cfg.xml's through <b>addResource</b> <i>only</i> processes class mappings -- it ignores properties and listeners etc.  However, you can add hibernate.cfg.xml's through the the .configure method and those are still processed as they were before Hibernate4.</p> <pre class="brush: java"><br />    @Bean<br />    public SessionFactory sessionFactory() {<br />        return new LocalSessionFactoryBuilder(dataConfig.dataSource())<br />            .scanPackages(DatabasePackage)<br />            .addPackage(DatabasePackage)<br />            .addProperties(dataConfig.hibernateProperties())<br />            .configure("hibernate.local.cfg.xml")<br />            .buildSessionFactory();<br />    }<br /></pre> <p>I couldn't find this well documented anywhere, nor was it specifically mentioned on the <a href="https://community.jboss.org/wiki/HibernateCoreMigrationGuide40">migration guide</a> as a consideration.  They do mention not paying attention to event listeners anymore, but don't mention properties.</p> <p>No big deal -- just lost some time :(</p><br/><br/>Steve